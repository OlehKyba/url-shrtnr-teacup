shell: /bin/sh

env:
  DOCKER_BUILDKIT: "1"

eval_env:
  JAVA_HOME: echo "${HOME}/.jdks/openjdk-15.0.2/"

commands:
  build:
    description: Build python
    cmd: docker build --tag stress-test .

  test-30-1:
    description: Run 1 query per second for 30 seconds
    cmd: |
      cd ..
      ./gradlew run& > /dev/null 2>&1
      docker run \
        --net host \
        --mount type=bind,source="$(pwd)/stress-test/.data",target="/tmp/data" \
        --mount type=bind,source="$(pwd)/stress-test/.report",target="/tmp/report" \
        stress-test python3 test.py
      ./gradlew --stop
      rm -r .data/

  test-30-10:
    description: Run 1 query per second for 30 seconds
    cmd: |
      cd ..
      ./gradlew run& > /dev/null 2>&1
      docker run \
        --net host \
        --mount type=bind,source="$(pwd)/stress-test/.data",target="/tmp/data" \
        --mount type=bind,source="$(pwd)/stress-test/.report",target="/tmp/report" \
        stress-test python3 test.py --rps 10
      ./gradlew --stop
      rm -r .data/

  test-30-25:
    description: Run 1 query per second for 30 seconds
    cmd: |
      cd ..
      ./gradlew run& > /dev/null 2>&1
      docker run \
        --net host \
        --mount type=bind,source="$(pwd)/stress-test/.data",target="/tmp/data" \
        --mount type=bind,source="$(pwd)/stress-test/.report",target="/tmp/report" \
        stress-test python3 test.py --rps 25
      ./gradlew --stop
      rm -r .data/

  test-30-50:
    description: Run 1 query per second for 30 seconds
    cmd: |
      cd ..
      ./gradlew run& > /dev/null 2>&1
      docker run \
        --net host \
        --mount type=bind,source="$(pwd)/stress-test/.data",target="/tmp/data" \
        --mount type=bind,source="$(pwd)/stress-test/.report",target="/tmp/report" \
        stress-test python3 test.py --rps 50
      ./gradlew --stop
      rm -r .data/

  test-30-100:
    description: Run 1 query per second for 30 seconds
    cmd: |
      cd ..
      ./gradlew run& > /dev/null 2>&1
      docker run \
        --net host \
        --mount type=bind,source="$(pwd)/stress-test/.data",target="/tmp/data" \
        --mount type=bind,source="$(pwd)/stress-test/.report",target="/tmp/report" \
        stress-test python3 test.py --rps 100
      ./gradlew --stop
      rm -r .data/

  test-30-200:
    description: Run 1 query per second for 30 seconds
    cmd: |
      cd ..
      ./gradlew run& > /dev/null 2>&1
      docker run \
        --net host \
        --mount type=bind,source="$(pwd)/stress-test/.data",target="/tmp/data" \
        --mount type=bind,source="$(pwd)/stress-test/.report",target="/tmp/report" \
        stress-test python3 test.py --rps 200
      ./gradlew --stop
      rm -r .data/

  test:
    description: Gather all data
    depends:
      - test-30-1
      - test-30-10
      - test-30-25
      - test-30-50
      - test-30-100
      - test-30-200

  clean:
    description: Remove experiments data
    cmd: rm -r .data/
